{"version":3,"file":"useBillingSubscription.js","sourceRoot":"","sources":["../../src/hooks/useBillingSubscription.ts"],"names":[],"mappings":"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","sourcesContent":["import { useCallback, useEffect, useState } from \"react\";\nimport { Platform } from \"react-native\";\nimport type { ConnectOptions, PurchaseResult } from \"../CafeBazaarBilling.types\";\nimport { getBillingModule } from \"../nativeModule\";\n\nexport type UseBillingSubscriptionOptions = ConnectOptions;\n\nexport type UseBillingSubscriptionResult = {\n  /** Active subscription for this product, or null if none / expired. */\n  activeSubscription: PurchaseResult | null;\n  /** True while checking subscription status on mount or after refresh(). */\n  loading: boolean;\n  /** Start subscription flow. Resolves with result on success. */\n  subscribe: (options?: { developerPayload?: string; dynamicPriceToken?: string }) => Promise<PurchaseResult | null>;\n  /** True while subscribe flow is in progress. */\n  subscribing: boolean;\n  /** Last error message from subscribe or refresh. */\n  error: string | null;\n  /** Re-query subscription status from Bazaar. */\n  refresh: () => Promise<void>;\n  /** False when billing is not available (e.g. not Android or module not linked). */\n  isAvailable: boolean;\n};\n\nexport function useBillingSubscription(\n  productId: string,\n  connectOptions?: UseBillingSubscriptionOptions,\n): UseBillingSubscriptionResult {\n  const billing = getBillingModule();\n  const isAvailable =\n    Platform.OS === \"android\" && billing !== null && billing !== undefined;\n\n  const [activeSubscription, setActiveSubscription] =\n    useState<PurchaseResult | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [subscribing, setSubscribing] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const fetchStatus = useCallback(async () => {\n    if (!billing) {\n      setActiveSubscription(null);\n      setLoading(false);\n      return;\n    }\n    setLoading(true);\n    setError(null);\n    try {\n      await billing.connect(connectOptions);\n      const result = await billing.querySubscribeProduct(productId);\n      setActiveSubscription(result ?? null);\n    } catch {\n      setActiveSubscription(null);\n    } finally {\n      setLoading(false);\n      billing.disconnect().catch(() => {});\n    }\n  }, [billing, productId, connectOptions?.rsaPublicKey]);\n\n  useEffect(() => {\n    if (!isAvailable) {\n      setLoading(false);\n      setActiveSubscription(null);\n      return;\n    }\n    let cancelled = false;\n    fetchStatus().then(() => {\n      if (cancelled) return;\n    });\n    return () => {\n      cancelled = true;\n    };\n  }, [isAvailable, fetchStatus]);\n\n  const subscribe = useCallback(\n    async (options?: {\n      developerPayload?: string;\n      dynamicPriceToken?: string;\n    }) => {\n      if (!billing || !isAvailable) return null;\n      setError(null);\n      setSubscribing(true);\n      try {\n        await billing.connect(connectOptions);\n        const result = await billing.subscribeProduct(productId, options);\n        await billing.disconnect();\n        setActiveSubscription(result);\n        return result;\n      } catch (e) {\n        const message = e instanceof Error ? e.message : \"Subscribe failed\";\n        setError(message);\n        return null;\n      } finally {\n        setSubscribing(false);\n        billing.disconnect().catch(() => {});\n      }\n    },\n    [billing, isAvailable, productId, connectOptions],\n  );\n\n  return {\n    activeSubscription,\n    loading,\n    subscribe,\n    subscribing,\n    error,\n    refresh: fetchStatus,\n    isAvailable,\n  };\n}\n"]}