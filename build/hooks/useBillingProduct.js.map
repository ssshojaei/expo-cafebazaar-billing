{"version":3,"file":"useBillingProduct.js","sourceRoot":"","sources":["../../src/hooks/useBillingProduct.ts"],"names":[],"mappings":"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","sourcesContent":["import { useCallback, useEffect, useState } from \"react\";\nimport { Platform } from \"react-native\";\nimport type { ConnectOptions, PurchaseResult } from \"../CafeBazaarBilling.types\";\nimport { getBillingModule } from \"../nativeModule\";\n\nexport type UseBillingProductOptions = ConnectOptions;\n\nexport type UseBillingProductResult = {\n  /** Whether the product is already purchased. */\n  purchased: PurchaseResult | null;\n  /** True while checking purchase status on mount or after refresh(). */\n  loading: boolean;\n  /** Start purchase flow. Resolves with result on success. */\n  purchase: (options?: { developerPayload?: string; dynamicPriceToken?: string }) => Promise<PurchaseResult | null>;\n  /** True while purchase flow is in progress. */\n  purchasing: boolean;\n  /** Last error message from purchase or refresh. */\n  error: string | null;\n  /** Re-query purchase status from Bazaar. */\n  refresh: () => Promise<void>;\n  /** False when billing is not available (e.g. not Android or module not linked). */\n  isAvailable: boolean;\n};\n\nexport function useBillingProduct(\n  productId: string,\n  connectOptions?: UseBillingProductOptions,\n): UseBillingProductResult {\n  const billing = getBillingModule();\n  const isAvailable =\n    Platform.OS === \"android\" && billing !== null && billing !== undefined;\n\n  const [purchased, setPurchased] = useState<PurchaseResult | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [purchasing, setPurchasing] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const fetchStatus = useCallback(async () => {\n    if (!billing) {\n      setPurchased(null);\n      setLoading(false);\n      return;\n    }\n    setLoading(true);\n    setError(null);\n    try {\n      await billing.connect(connectOptions);\n      const result = await billing.queryPurchaseProduct(productId);\n      setPurchased(result ?? null);\n    } catch {\n      setPurchased(null);\n    } finally {\n      setLoading(false);\n      billing.disconnect().catch(() => {});\n    }\n  }, [billing, productId, connectOptions?.rsaPublicKey]);\n\n  useEffect(() => {\n    if (!isAvailable) {\n      setLoading(false);\n      setPurchased(null);\n      return;\n    }\n    let cancelled = false;\n    fetchStatus().then(() => {\n      if (cancelled) return;\n    });\n    return () => {\n      cancelled = true;\n    };\n  }, [isAvailable, fetchStatus]);\n\n  const purchase = useCallback(\n    async (options?: {\n      developerPayload?: string;\n      dynamicPriceToken?: string;\n    }) => {\n      if (!billing || !isAvailable) return null;\n      setError(null);\n      setPurchasing(true);\n      try {\n        await billing.connect(connectOptions);\n        const result = await billing.purchaseProduct(productId, options);\n        await billing.disconnect();\n        setPurchased(result);\n        return result;\n      } catch (e) {\n        const message = e instanceof Error ? e.message : \"Purchase failed\";\n        setError(message);\n        return null;\n      } finally {\n        setPurchasing(false);\n        billing.disconnect().catch(() => {});\n      }\n    },\n    [billing, isAvailable, productId, connectOptions],\n  );\n\n  return {\n    purchased,\n    loading,\n    purchase,\n    purchasing,\n    error,\n    refresh: fetchStatus,\n    isAvailable,\n  };\n}\n"]}